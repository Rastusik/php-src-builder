#!/usr/bin/env bash

set -o xtrace
set -o errexit

# If PHP < 7.2, exit
if [[ ! $VERSION =~ ^master$ ]] && [[ "$(printf "7.2\n$VERSION" | sort -V | head -n1)" < "7.2" ]]; then
	echo 'PHP < 7.2; skip libsodium steps'
	exit 0
fi

LIBSODIUM_INSTALL_DIR=$HOME/.phpenv/versions/$VERSION

curl -sfSLO --retry 20 https://github.com/jedisct1/libsodium/releases/download/1.0.7/libsodium-1.0.7.tar.gz
tar xzf libsodium-1.0.7.tar.gz
# compile
pushd libsodium-1.0.7
./configure --prefix=$LIBSODIUM_INSTALL_DIR
make check
make install
popd

# add the option in default_configure_options
echo "--with-sodium=$LIBSODIUM_INSTALL_DIR" >> $TRAVIS_BUILD_DIR/default_configure_options.${RELEASE}
